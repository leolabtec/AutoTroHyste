#!/bin/bash
# =========================================
# Sing-box 全协议节点管理脚本 - 最强伪装终极版
# Trojan 443 端口添加 fallback 到伪装站点
# 浏览器直接访问域名 → 完美打开伪装网页（最强伪装）
# 支持 Trojan + Hysteria2 + Tuic + 自动续期 + NodeList 订阅
# =========================================

FAKEWEB_DIR="/home/wzweb"
FAKEWEB_PORT=8080
SINGBOX_CONFIG="/etc/sing-box/config.json"
ACME_HOME="$HOME/.acme.sh"
CERT_DIR="/root/cert"
SINGBOX_SERVICE="/etc/systemd/system/sing-box.service"

MENU_STATUS=("inactive" "inactive" "inactive" "inactive")
DOMAIN=""
TROJAN_PORT=443
TROJAN_PASS=""
HYSTERIA2_PORT=""
HYSTERIA2_PASS=""
TUIC_PORT=""
TUIC_UUID=""
TUIC_PASS=""
HYSTERIA_BANDWIDTH=500

generate_password() { openssl rand -base64 32 | tr -dc 'A-Za-z0-9' | head -c 20; }
generate_uuid() { sing-box generate uuid; }

check_port() {
    local port=$1
    local temp_stop=0
    if systemctl is-active --quiet sing-box && (ss -tuln | grep -q ":$port " || ss -uapn | grep -q ":$port "); then
        systemctl stop sing-box
        temp_stop=1
    fi
    if ss -tuln | grep -q ":$port " || ss -uapn | grep -q ":$port "; then
        [ $temp_stop -eq 1 ] && systemctl start sing-box
        echo "端口 $port 已被占用（TCP 或 UDP），请重新输入。"
        return 1
    else
        [ $temp_stop -eq 1 ] && systemctl start sing-box
        return 0
    fi
}

install_dependencies() {
    echo "安装必要依赖..."
    DEPS=(socat unzip cron dnsutils docker.io docker-compose openssl curl ss jq)
    for pkg in "${DEPS[@]}"; do
        if ! dpkg -s $pkg >/dev/null 2>&1; then
            apt update -y && apt install -y $pkg
        fi
    done
    systemctl enable docker && systemctl start docker
}

install_singbox() {
    echo "安装最新版 sing-box..."
    ARCH=$(uname -m)
    [ "$ARCH" = "x86_64" ] && ARCH="amd64" || ARCH="arm64"
    LATEST=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep tag_name | cut -d '"' -f4 | sed 's/v//')
    curl -L https://github.com/SagerNet/sing-box/releases/download/v${LATEST}/sing-box-${LATEST}-linux-${ARCH}.tar.gz -o /tmp/sb.tar.gz
    tar -xzf /tmp/sb.tar.gz -C /tmp
    mv /tmp/sing-box-${LATEST}-linux-${ARCH}/sing-box /usr/local/bin/
    chmod +x /usr/local/bin/sing-box
    rm -rf /tmp/sb*
    echo "sing-box 安装完成: v$LATEST"
}

check_singbox() { command -v sing-box >/dev/null || install_singbox; }

check_acme() {
    [ ! -d "$ACME_HOME" ] && curl https://get.acme.sh | sh && source ~/.bashrc
    $ACME_HOME/acme.sh --set-default-ca --server letsencrypt
}

deploy_fakeweb() {
    mkdir -p "$FAKEWEB_DIR"
    cd "$FAKEWEB_DIR" || return
    cat > docker-compose.yml <<EOF
version: '3'
services:
  fakeweb:
    image: hongcheng618/wzweb
    ports:
      - "$FAKEWEB_PORT:80"
    restart: always
EOF
    docker-compose up -d || true
}

create_systemd_service() {
    [ -f "$SINGBOX_SERVICE" ] && return
    cat > "$SINGBOX_SERVICE" <<EOF
[Unit]
Description=sing-box service
After=network.target

[Service]
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
ExecStart=/usr/local/bin/sing-box run -c $SINGBOX_CONFIG
Restart=on-failure
LimitNOFILE=infinity

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload && systemctl enable sing-box
}

load_existing_config() {
    if [ -f "$CERT_DIR/fullchain.pem" ]; then
        MENU_STATUS[0]="active"
        DOMAIN=$(openssl x509 -in "$CERT_DIR/fullchain.pem" -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p' | head -n1)
    fi

    if [ -f "$SINGBOX_CONFIG" ] && command -v jq >/dev/null && jq empty "$SINGBOX_CONFIG" >/dev/null 2>&1; then
        mapfile -t types < <(jq -r '.inbounds[].type' "$SINGBOX_CONFIG")
        mapfile -t ports < <(jq -r '.inbounds[].listen_port' "$SINGBOX_CONFIG")
        mapfile -t passwords < <(jq -r '.inbounds[].users[0].password // empty' "$SINGBOX_CONFIG")
        mapfile -t uuids < <(jq -r '.inbounds[].users[0].uuid // empty' "$SINGBOX_CONFIG")

        for i in "${!types[@]}"; do
            case "${types[$i]}" in
                trojan)    MENU_STATUS[1]="active"; TROJAN_PORT="${ports[$i]}"; TROJAN_PASS="${passwords[$i]}"; ;;
                hysteria2) MENU_STATUS[2]="active"; HYSTERIA2_PORT="${ports[$i]}"; HYSTERIA2_PASS="${passwords[$i]}"; ;;
                tuic)      MENU_STATUS[3]="active"; TUIC_PORT="${ports[$i]}"; TUIC_UUID="${uuids[$i]}"; TUIC_PASS="${passwords[$i]}"; ;;
            esac
        done
    fi
}

issue_cert() {
    [ "${MENU_STATUS[0]}" = "active" ] && { echo "证书已存在（域名: $DOMAIN）"; return; }
    read -p "请输入域名: " DOMAIN
    [[ -z "$DOMAIN" ]] && return
    mkdir -p "$CERT_DIR"

    if [ -f "$FAKEWEB_DIR/docker-compose.yml" ]; then
        cd "$FAKEWEB_DIR" && docker-compose down >/dev/null 2>&1
    fi

    $ACME_HOME/acme.sh --issue --standalone -d "$DOMAIN" --keylength ec-256 --force || {
        echo "证书申请失败"
        cd "$FAKEWEB_DIR" && docker-compose up -d >/dev/null 2>&1
        return
    }

    $ACME_HOME/acme.sh --install-cert -d "$DOMAIN" --ecc \
        --fullchain-file "$CERT_DIR/fullchain.pem" \
        --key-file "$CERT_DIR/private.pem"

    HOOK="$ACME_HOME/singbox-hook.sh"
    cat > "$HOOK" <<'EOF'
#!/bin/bash
FAKEWEB_DIR="/home/wzweb"
if [ -f "$FAKEWEB_DIR/docker-compose.yml" ]; then
    cd "$FAKEWEB_DIR" && docker-compose down >/dev/null 2>&1
fi
cp "$1" "/root/cert/fullchain.pem"
cp "$2" "/root/cert/private.pem"
systemctl restart sing-box
if [ -f "$FAKEWEB_DIR/docker-compose.yml" ]; then
    cd "$FAKEWEB_DIR" && docker-compose up -d >/dev/null 2>&1
fi
EOF
    chmod +x "$HOOK"

    $ACME_HOME/acme.sh --install-cert -d "$DOMAIN" --ecc --reloadcmd "$HOOK"
    $ACME_HOME/acme.sh --upgrade --auto-upgrade

    cd "$FAKEWEB_DIR" && docker-compose up -d >/dev/null 2>&1

    MENU_STATUS[0]="active"
}

configure_singbox() {
    mkdir -p /etc/sing-box
    INBOUNDS=""
    # Trojan 添加 fallback 到伪装站点，实现最强伪装
    [ "${MENU_STATUS[1]}" = "active" ] && INBOUNDS+='{
        "type":"trojan",
        "tag":"trojan-in",
        "listen":"0.0.0.0",
        "listen_port":'"$TROJAN_PORT"',
        "users":[{"password":"'"$TROJAN_PASS"'"}],
        "tls":{
            "enabled":true,
            "certificate_path":"'"$CERT_DIR/fullchain.pem"'",
            "key_path":"'"$CERT_DIR/private.pem"'"
        },
        "fallback":{
            "server":"127.0.0.1",
            "server_port":'"$FAKEWEB_PORT"'
        }
    },'
    [ "${MENU_STATUS[2]}" = "active" ] && INBOUNDS+='{
        "type":"hysteria2",
        "tag":"hysteria2-in",
        "listen":"0.0.0.0",
        "listen_port":'"$HYSTERIA2_PORT"',
        "up_mbps":'"$HYSTERIA_BANDWIDTH"',
        "down_mbps":'"$HYSTERIA_BANDWIDTH"',
        "users":[{"password":"'"$HYSTERIA2_PASS"'"}],
        "tls":{
            "enabled":true,
            "certificate_path":"'"$CERT_DIR/fullchain.pem"'",
            "key_path":"'"$CERT_DIR/private.pem"'"
        }
    },'
    [ "${MENU_STATUS[3]}" = "active" ] && INBOUNDS+='{
        "type":"tuic",
        "tag":"tuic-in",
        "listen":"0.0.0.0",
        "listen_port":'"$TUIC_PORT"',
        "users":[{"uuid":"'"$TUIC_UUID"'","password":"'"$TUIC_PASS"'"}],
        "congestion_control":"cubic",
        "tls":{
            "enabled":true,
            "certificate_path":"'"$CERT_DIR/fullchain.pem"'",
            "key_path":"'"$CERT_DIR/private.pem"'"
        }
    },'
    INBOUNDS=${INBOUNDS%,}
    cat > "$SINGBOX_CONFIG" <<EOF
{
  "log": {"level": "info"},
  "inbounds": [$INBOUNDS],
  "outbounds": [{"type": "direct", "tag": "direct"}]
}
EOF
}

restart_singbox() { systemctl restart sing-box; }

print_all_nodes_and_nodelist() {
    echo -e "\n\033[1;32m========== 所有节点连接信息 ==========\033[0m"
    [ "${MENU_STATUS[1]}" = "active" ] && echo "Trojan:    trojan://$TROJAN_PASS@$DOMAIN:$TROJAN_PORT?#Trojan"
    [ "${MENU_STATUS[2]}" = "active" ] && echo "Hysteria2: hysteria2://$HYSTERIA2_PASS@$DOMAIN:$HYSTERIA2_PORT/?sni=$DOMAIN#Hysteria2"
    [ "${MENU_STATUS[3]}" = "active" ] && echo "Tuic:      tuic://$TUIC_UUID:$TUIC_PASS@$DOMAIN:$TUIC_PORT/?sni=$DOMAIN&congestion_control=cubic#Tuic"
    echo -e "\033[1;32m======================================\033[0m\n"

    local nodelist=""
    [ "${MENU_STATUS[1]}" = "active" ] && nodelist+="trojan://$TROJAN_PASS@$DOMAIN:$TROJAN_PORT?#Trojan\n"
    [ "${MENU_STATUS[2]}" = "active" ] && nodelist+="hysteria2://$HYSTERIA2_PASS@$DOMAIN:$HYSTERIA2_PORT/?sni=$DOMAIN#Hysteria2\n"
    [ "${MENU_STATUS[3]}" = "active" ] && nodelist+="tuic://$TUIC_UUID:$TUIC_PASS@$DOMAIN:$TUIC_PORT/?sni=$DOMAIN&congestion_control=cubic#Tuic\n"

    if [[ -n "$nodelist" ]]; then
        local base64=$(echo -e "$nodelist" | base64 -w 0)
        echo -e "\033[1;33m========== NodeList 订阅（Base64）==========\033[0m"
        echo "$base64"
        echo -e "\033[1;33m复制上方 Base64 保存为文件或用于订阅转换\033[0m\n"
    fi
}

show_menu() {
    while true; do
        clear
        echo "========== Sing-box 节点管理 =========="
        echo "1. 创建/查看域名证书 [${MENU_STATUS[0]}] ${DOMAIN:+域名:$DOMAIN}"
        echo "2. Trojan 节点     [${MENU_STATUS[1]}] ${TROJAN_PORT:+端口:$TROJAN_PORT} ${MENU_STATUS[1]:+（已启用 fallback 伪装）}"
        echo "3. Hysteria2 节点  [${MENU_STATUS[2]}] ${HYSTERIA2_PORT:+端口:$HYSTERIA2_PORT}"
        echo "4. Tuic 节点       [${MENU_STATUS[3]}] ${TUIC_PORT:+端口:$TUIC_PORT}"
        echo "5. 查看所有节点信息和订阅"
        echo "0. 退出"
        echo "=================================="
        read -p "选择: " c
        case $c in
            1) issue_cert; create_systemd_service ;;
            2|3|4)
                [ "${MENU_STATUS[0]}" != "active" ] && { echo "请先创建证书"; read -n1 -s; continue; }
                if [[ $c == 2 && "${MENU_STATUS[1]}" == "active" ]] || [[ $c == 3 && "${MENU_STATUS[2]}" == "active" ]] || [[ $c == 4 && "${MENU_STATUS[3]}" == "active" ]]; then
                    echo "该节点已启用"
                    read -p "是否重新配置？(y/N): " reconf
                    [[ ! "$reconf" =~ ^[Yy]$ ]] && continue
                fi

                if [[ $c == 2 ]]; then
                    read -p "Trojan 端口 (默认443): " p; TROJAN_PORT=${p:-443}
                    while ! check_port $TROJAN_PORT; do read -p "重新输入: " TROJAN_PORT; done
                    TROJAN_PASS=$(generate_password)
                    echo "新密码: $TROJAN_PASS"
                    MENU_STATUS[1]="active"
                elif [[ $c == 3 ]]; then
                    read -p "Hysteria2 端口: " HYSTERIA2_PORT
                    while ! check_port $HYSTERIA2_PORT || [ -z "$HYSTERIA2_PORT" ]; do read -p "重新输入: " HYSTERIA2_PORT; done
                    HYSTERIA2_PASS=$(generate_password)
                    echo "新密码: $HYSTERIA2_PASS"
                    MENU_STATUS[2]="active"
                else
                    read -p "Tuic 端口: " TUIC_PORT
                    while ! check_port $TUIC_PORT || [ -z "$TUIC_PORT" ]; do read -p "重新输入: " TUIC_PORT; done
                    TUIC_UUID=$(generate_uuid)
                    TUIC_PASS=$(generate_password)
                    echo "UUID: $TUIC_UUID"
                    echo "密码: $TUIC_PASS"
                    MENU_STATUS[3]="active"
                fi

                configure_singbox
                restart_singbox
                print_all_nodes_and_nodelist
                ;;
            5) print_all_nodes_and_nodelist ;;
            0) exit 0 ;;
            *) echo "无效选项"; read -n1 -s ;;
        esac
        read -p "按回车继续..."
    done
}

# 主流程
install_dependencies
check_singbox
check_acme
deploy_fakeweb
create_systemd_service
load_existing_config
show_menu
