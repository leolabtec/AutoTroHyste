#!/bin/bash
set -euo pipefail

# ===============================
# å½©è‰²è¾“å‡º
# ===============================
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# ===============================
# 1ï¸âƒ£ è¾“å…¥åŸŸåå¹¶æ£€æŸ¥è§£æžæ˜¯å¦åŒ¹é…æœ¬æœºå…¬ç½‘
# ===============================
read -p "è¯·è¾“å…¥ä½ çš„åŸŸåï¼ˆç¡®ä¿å·²è§£æžï¼‰: " DOMAIN

# åŸŸåè§£æž
resolve_ipv4=$(dig +short A "$DOMAIN" | head -n1 || true)
resolve_ipv6=$(dig +short AAAA "$DOMAIN" | head -n1 || true)

if [[ -z "$resolve_ipv4" && -z "$resolve_ipv6" ]]; then
    echo -e "${RED}é”™è¯¯ï¼šåŸŸåæœªè§£æžåˆ°ä»»ä½•å…¬ç½‘ IPï¼${NC}"
    exit 1
fi

# èŽ·å–æœ¬æœºå…¬ç½‘ IP
my_ipv4=$(curl -s https://ifconfig.me)
my_ipv6=$(curl -s https://ifconfig.me -6 || true)

# æ ¡éªŒ IPv4
if [[ -n "$resolve_ipv4" && "$resolve_ipv4" != "$my_ipv4" ]]; then
    echo -e "${RED}é”™è¯¯ï¼šåŸŸåè§£æžçš„ IPv4 ($resolve_ipv4) ä¸Žæœ¬æœºå…¬ç½‘ IPv4 ($my_ipv4) ä¸åŒ¹é…ï¼${NC}"
    exit 1
fi

# æ ¡éªŒ IPv6ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
if [[ -n "$resolve_ipv6" && "$my_ipv6" != "" && "$resolve_ipv6" != "$my_ipv6" ]]; then
    echo -e "${RED}é”™è¯¯ï¼šåŸŸåè§£æžçš„ IPv6 ($resolve_ipv6) ä¸Žæœ¬æœºå…¬ç½‘ IPv6 ($my_ipv6) ä¸åŒ¹é…ï¼${NC}"
    exit 1
fi

echo -e "${GREEN}åŸŸåè§£æžæˆåŠŸä¸”åŒ¹é…æœ¬æœºå…¬ç½‘ IP${NC}"


# ===============================
# 2ï¸âƒ£ å®‰è£…ä¾èµ–
# ===============================
echo -e "${GREEN}å®‰è£…å¿…è¦ä¾èµ–...${NC}"
apt update -y
apt install -y curl wget socat unzip cron dnsutils docker.io docker-compose

systemctl enable --now cron

# ===============================
# 3ï¸âƒ£ å®‰è£… acme.sh
# ===============================
if [[ ! -d ~/.acme.sh ]]; then
  curl https://get.acme.sh | sh
fi
export PATH=~/.acme.sh:$PATH
#source ~/.bashrc || true

# ===============================
# 4ï¸âƒ£ åˆ›å»ºç›®å½•ä¸Žä¼ªè£…ç«™ç‚¹
# ===============================
mkdir -p /root/trojan
mkdir -p /etc/hysteria
mkdir -p /home/wzweb

cd /home/wzweb
cat > docker-compose.yml <<EOF
version: '3'
services:
  fakeweb:
    image: hongcheng618/wzweb
    container_name: fakeweb
    ports:
      - "8080:80"
    restart: always
EOF

docker-compose up -d

# ===============================
# 5ï¸âƒ£ ä¸‹è½½å¹¶é…ç½® trojan-go
# ===============================
cd /root/trojan
if [[ ! -f trojan-go ]]; then
  wget -O trojan-go.zip https://github.com/p4gefau1t/trojan-go/releases/download/v0.10.6/trojan-go-linux-amd64.zip
  unzip -o trojan-go.zip
  chmod +x trojan-go
fi

PASSWORD=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 20)

cat > config.json <<EOF
{
  "run_type": "server",
  "local_addr": "0.0.0.0",
  "local_port": 443,
  "remote_addr": "127.0.0.1",
  "remote_port": 8080,
  "password": ["$PASSWORD"],
  "ssl": {
    "cert": "/root/trojan/server.crt",
    "key": "/root/trojan/server.key",
    "sni": "$DOMAIN"
  },
  "router": {
    "enabled": true,
    "block": ["geoip:private"]
  }
}
EOF

# ===============================
# 6ï¸âƒ£ åˆ›å»º systemd æœåŠ¡
# ===============================
cat > /etc/systemd/system/trojan-go.service <<EOF
[Unit]
Description=Trojan-Go Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/trojan
ExecStart=/root/trojan/trojan-go -config /root/trojan/config.json
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable trojan-go

# ===============================
# 7ï¸âƒ£ ç”³è¯· SSL è¯ä¹¦
# ===============================
echo -e "${GREEN}ç”³è¯· SSL è¯ä¹¦...${NC}"
~/.acme.sh/acme.sh --set-default-ca --server letsencrypt

# é¦–æ¬¡ç­¾å‘ï¼ˆä½¿ç”¨ standaloneï¼Œè‡ªåŠ¨ç›‘å¬80ï¼‰
~/.acme.sh/acme.sh --issue -d $DOMAIN --standalone --keylength ec-256

# ===============================
# 8ï¸âƒ£ å®‰è£…è¯ä¹¦å¹¶æ·»åŠ  hooksï¼ˆé‡ç‚¹ä¼˜åŒ–éƒ¨åˆ†ï¼‰
# ===============================
~/.acme.sh/acme.sh --installcert -d $DOMAIN --ecc \
  --key-file /root/trojan/server.key \
  --fullchain-file /root/trojan/server.crt \
  --reloadcmd "bash /root/renew_hook.sh" \
  --pre-hook "bash /root/pre_stop_hook.sh"

# åˆ›å»º pre-hookï¼šåœ¨ç»­ç­¾å‰åœæ­¢æœåŠ¡
cat > /root/pre_stop_hook.sh <<'EOF'
#!/bin/bash
echo "[HOOK] åœæ­¢ Trojan-Go ä¸Ž Hysteria æœåŠ¡ä»¥é‡Šæ”¾ç«¯å£..."
systemctl stop hysteria-server.service 2>/dev/null || true
systemctl stop trojan-go.service 2>/dev/null || true
EOF
chmod +x /root/pre_stop_hook.sh

# åˆ›å»º reload-hookï¼šç»­ç­¾æˆåŠŸåŽæ›´æ–°æ–‡ä»¶å¹¶é‡å¯æœåŠ¡
cat > /root/renew_hook.sh <<'EOF'
#!/bin/bash
echo "[HOOK] è¯ä¹¦ç»­ç­¾æˆåŠŸï¼Œæ›´æ–°åˆ° Hysteria å¹¶é‡å¯æœåŠ¡..."

# å¤åˆ¶è¯ä¹¦åˆ° Hysteria ç›®å½•
cp -f /root/trojan/server.crt /etc/hysteria/server.crt
cp -f /root/trojan/server.key /etc/hysteria/server.key

# ç¡®ä¿æƒé™
chmod 600 /root/trojan/server.key /etc/hysteria/server.key

# é‡å¯æœåŠ¡
systemctl restart trojan-go.service
systemctl restart hysteria-server.service

echo "[HOOK] å·²é‡å¯ Trojan-Go ä¸Ž Hysteria æœåŠ¡ã€‚"
EOF
chmod +x /root/renew_hook.sh

# ===============================
# 9ï¸âƒ£ å¯åŠ¨æœåŠ¡
# ===============================
systemctl start trojan-go

# ===============================
# ðŸ”Ÿ è¾“å‡ºèŠ‚ç‚¹ä¿¡æ¯
# ===============================
echo -e "\n${GREEN}Trojan-Go èŠ‚ç‚¹éƒ¨ç½²æˆåŠŸï¼${NC}"
echo -e "åŸŸåï¼š$DOMAIN"
echo -e "ç«¯å£ï¼š443"
echo -e "å¯†ç ï¼š$PASSWORD"
echo -e "SNIï¼š$DOMAIN"
echo -e "ä¼ªè£…ç«™ç‚¹ï¼šhttp://$DOMAIN/"
echo -e "\n${GREEN}è¯ä¹¦è·¯å¾„ï¼š${NC}"
echo -e "Trojan-Go: /root/trojan/server.crt"
echo -e "Hysteria : /etc/hysteria/server.crt"
echo -e "\n${GREEN}acme.sh å°†è‡ªåŠ¨ç»­ç­¾è¯ä¹¦ï¼Œå¹¶åœ¨ç»­ç­¾å‰åœæ­¢æœåŠ¡ï¼Œç»­ç­¾åŽè‡ªåŠ¨å¤åˆ¶å’Œé‡å¯ã€‚${NC}"
