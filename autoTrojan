#!/bin/bash
set -euo pipefail

# ============ 配色 ============
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# ===============================
# 1️⃣ 输入域名并检查解析是否匹配本机公网
# ===============================
read -p "请输入你的域名（确保已解析）: " DOMAIN

# 域名解析
resolve_ipv4=$(dig +short A "${DOMAIN}" | head -n1 || true)
resolve_ipv6=$(dig +short AAAA "${DOMAIN}" | head -n1 || true)

if [[ -z "$resolve_ipv4" && -z "$resolve_ipv6" ]]; then
    echo -e "${RED}错误：域名未解析到任何公网 IP！${NC}"
    exit 1
fi

# 获取本机公网 IP
my_ipv4=$(curl -s https://ifconfig.me)
my_ipv6=$(curl -s https://ifconfig.me -6 || true)

# 校验 IPv4
if [[ -n "$resolve_ipv4" && "$resolve_ipv4" != "$my_ipv4" ]]; then
    echo -e "${RED}错误：域名解析的 IPv4 ($resolve_ipv4) 与本机公网 IPv4 ($my_ipv4) 不匹配！${NC}"
    exit 1
fi

# 校验 IPv6（如果存在）
if [[ -n "$resolve_ipv6" && "$my_ipv6" != "" && "$resolve_ipv6" != "$my_ipv6" ]]; then
    echo -e "${RED}错误：域名解析的 IPv6 ($resolve_ipv6) 与本机公网 IPv6 ($my_ipv6) 不匹配！${NC}"
    exit 1
fi

echo -e "${GREEN}域名解析成功且匹配本机公网 IP${NC}"


# ============ 安装依赖 ============
echo -e "${GREEN}安装必要依赖...${NC}"
apt update -y
apt install -y curl wget socat unzip cron dnsutils docker.io docker-compose
systemctl enable --now cron

# ============ 安装 acme.sh ============
if [[ ! -d ~/.acme.sh ]]; then
  curl https://get.acme.sh | sh
fi
export PATH=~/.acme.sh:$PATH

# ============ 创建伪装网站 ============
mkdir -p /home/wzweb
cd /home/wzweb
cat > docker-compose.yml <<EOF
version: '3'
services:
  fakeweb:
    image: hongcheng618/wzweb
    container_name: fakeweb
    ports:
      - "8080:80"
    restart: always
EOF
docker-compose up -d

# ============ 下载 Trojan-Go ============
mkdir -p /root/trojan
cd /root/trojan
if [[ ! -f trojan-go ]]; then
  wget -O trojan-go.zip https://github.com/p4gefau1t/trojan-go/releases/download/v0.10.6/trojan-go-linux-amd64.zip
  unzip -o trojan-go.zip
  chmod +x trojan-go
fi

PASSWORD=$(openssl rand -base64 32 | tr -dc A-Za-z0-9 | head -c 20)

cat > config.json <<EOF
{
  "run_type": "server",
  "local_addr": "0.0.0.0",
  "local_port": 443,
  "remote_addr": "127.0.0.1",
  "remote_port": 8080,
  "password": [
    "$PASSWORD"
  ],
  "ssl": {
    "cert": "/root/trojan/server.crt",
    "key": "/root/trojan/server.key",
    "sni": "$DOMAIN"
  },
  "router": {
    "enabled": true,
    "block": [
      "geoip:private"
    ]
  }
}
EOF

# ============ 创建 systemd 服务 ============
cat > /etc/systemd/system/trojan-go.service <<EOF
[Unit]
Description=Trojan-Go Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/trojan
ExecStart=/root/trojan/trojan-go -config /root/trojan/config.json
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable trojan-go

# ============ 创建 Hysteria 目录 ============
HYSTERIA_DIR="/etc/hysteria"
HYSTERIA_USER="hysteria"

if [[ ! -d "$HYSTERIA_DIR" ]]; then
    mkdir -p "$HYSTERIA_DIR"
    if ! id -u "$HYSTERIA_USER" >/dev/null 2>&1; then
        useradd -r -s /usr/sbin/nologin "$HYSTERIA_USER"
    fi
    chown "$HYSTERIA_USER:$HYSTERIA_USER" "$HYSTERIA_DIR"
fi

# ============ 创建 hook.sh ============
cat > /root/hook.sh <<EOF
#!/bin/bash
set -euo pipefail

DOMAIN="$DOMAIN"
ACME_PATH="/root/.acme.sh/\${DOMAIN}_ecc"
SRC_CERT="\${ACME_PATH}/fullchain.cer"
SRC_KEY="\${ACME_PATH}/\${DOMAIN}.key"

TROJAN_DIR="/root/trojan"
HYSTERIA_DIR="/etc/hysteria"
HYSTERIA_USER="hysteria"

echo "[HOOK] 证书续签成功，开始覆盖并重启服务..."

# 停止服务
systemctl stop trojan-go.service 2>/dev/null || true
systemctl stop hysteria-server.service 2>/dev/null || true

# 覆盖 Trojan-Go 证书
echo "[HOOK] 更新 Trojan-Go 证书..."
install -m 600 "\$SRC_KEY" "\$TROJAN_DIR/server.key"
install -m 644 "\$SRC_CERT" "\$TROJAN_DIR/server.crt"
chown root:root "\$TROJAN_DIR/server.key" "\$TROJAN_DIR/server.crt"

# 覆盖 Hysteria 证书
if [[ -d "\$HYSTERIA_DIR" ]]; then
    echo "[HOOK] 更新 Hysteria 证书..."
    install -m 600 "\$SRC_KEY" "\$HYSTERIA_DIR/server.key"
    install -m 644 "\$SRC_CERT" "\$HYSTERIA_DIR/server.crt"
    chown "\$HYSTERIA_USER:\$HYSTERIA_USER" "\$HYSTERIA_DIR/server.key" "\$HYSTERIA_DIR/server.crt"
fi

# 重启服务
echo "[HOOK] 重启 Trojan-Go 与 Hysteria 服务..."
systemctl restart trojan-go.service
systemctl restart hysteria-server.service 2>/dev/null || true

echo "[HOOK] 已完成证书更新并重启服务."
EOF
chmod +x /root/hook.sh
chown root:root /root/hook.sh
chmod 700 /root/hook.sh

# ============ 申请证书 ============
~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
~/.acme.sh/acme.sh --issue -d "$DOMAIN" --standalone --keylength ec-256

# ============ 安装证书（首次安装同时覆盖 Trojan 和 Hysteria） ============
~/.acme.sh/acme.sh --installcert -d "$DOMAIN" --ecc \
  --key-file /root/trojan/server.key \
  --fullchain-file /root/trojan/server.crt \
  --reloadcmd "bash /root/hook.sh"

# ============ 自动升级 acme.sh ============
~/.acme.sh/acme.sh --upgrade --auto-upgrade

# ============ 启动 Trojan ============
systemctl restart trojan-go

# ============ 输出结果 ============
echo -e "\n${GREEN}✅ Trojan-Go + Hysteria2 一体部署完成！${NC}"
echo -e "域名：$DOMAIN"
echo -e "端口：443"
echo -e "密码：$PASSWORD"
echo -e "SNI：$DOMAIN"
echo -e "证书路径：/root/trojan/server.crt"
echo -e "证书Key：/root/trojan/server.key"
echo -e "证书同步
